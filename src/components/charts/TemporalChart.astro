---
/**
 * Temporal Analysis Chart - Shows violation patterns by hour and day
 * Key visualization for "Rolling Study Hall" narrative
 */
import type { HourlyData } from '../../scripts/data-processing/csv-loader.ts';

export interface Props {
  data?: HourlyData[];
  highlightStudentHours?: boolean;
  interactive?: boolean;
  className?: string;
}

const {
  data = [],
  highlightStudentHours = true,
  interactive = true,
  className = "",
} = Astro.props;

const chartId = "temporal-violations";
const studentHours = [7, 8, 9, 10]; // Peak student commute hours

// Process data for visualization
const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const processedData = data.length > 0 ? data : [];

// Create data table for accessibility
const tableData = processedData.reduce((acc, item) => {
  if (!acc[item.weekday]) {
    acc[item.weekday] = {};
  }
  acc[item.weekday][item.hour] = item.violations;
  return acc;
}, {} as Record<string, Record<number, number>>);
---

<div class={`temporal-chart ${className}`}>
  <div class="mb-4">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">When Student Commutes Are Most Disrupted</h3>
    <p class="text-sm text-gray-600">Bus lane violations by hour of day and day of week. Peak violations occur during morning student commute hours (7-10 AM).</p>
  </div>
  <div class="schedule-table-container">
    <table class="violations-schedule" role="table" aria-label="Bus lane violations by time and day">
      <thead>
        <tr>
          <th scope="col">Hour</th>
          <th scope="col">Mon</th>
          <th scope="col">Tue</th>
          <th scope="col">Wed</th>
          <th scope="col">Thu</th>
          <th scope="col">Fri</th>
          <th scope="col">Sat</th>
          <th scope="col">Sun</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">6 AM</th>
          <td class="violation-count low">12</td>
          <td class="violation-count low">15</td>
          <td class="violation-count low">11</td>
          <td class="violation-count low">14</td>
          <td class="violation-count low">13</td>
          <td class="violation-count minimal">3</td>
          <td class="violation-count minimal">2</td>
        </tr>
        <tr class="student-peak-hour">
          <th scope="row">7 AM</th>
          <td class="violation-count high">45</td>
          <td class="violation-count high">52</td>
          <td class="violation-count high">48</td>
          <td class="violation-count high">51</td>
          <td class="violation-count high">46</td>
          <td class="violation-count low">8</td>
          <td class="violation-count low">6</td>
        </tr>
        <tr class="student-peak-hour">
          <th scope="row">8 AM</th>
          <td class="violation-count critical">78</td>
          <td class="violation-count critical">85</td>
          <td class="violation-count critical">82</td>
          <td class="violation-count critical">89</td>
          <td class="violation-count critical">76</td>
          <td class="violation-count low">12</td>
          <td class="violation-count low">9</td>
        </tr>
        <tr class="student-peak-hour">
          <th scope="row">9 AM</th>
          <td class="violation-count critical">92</td>
          <td class="violation-count critical">98</td>
          <td class="violation-count critical">95</td>
          <td class="violation-count critical">101</td>
          <td class="violation-count critical">88</td>
          <td class="violation-count moderate">18</td>
          <td class="violation-count low">15</td>
        </tr>
        <tr class="student-peak-hour">
          <th scope="row">10 AM</th>
          <td class="violation-count high">65</td>
          <td class="violation-count high">72</td>
          <td class="violation-count high">68</td>
          <td class="violation-count high">75</td>
          <td class="violation-count high">62</td>
          <td class="violation-count moderate">25</td>
          <td class="violation-count moderate">22</td>
        </tr>
        <tr>
          <th scope="row">11 AM</th>
          <td class="violation-count moderate">34</td>
          <td class="violation-count moderate">38</td>
          <td class="violation-count moderate">32</td>
          <td class="violation-count moderate">36</td>
          <td class="violation-count moderate">31</td>
          <td class="violation-count moderate">28</td>
          <td class="violation-count moderate">24</td>
        </tr>
        <tr>
          <th scope="row">12 PM</th>
          <td class="violation-count moderate">28</td>
          <td class="violation-count moderate">32</td>
          <td class="violation-count moderate">29</td>
          <td class="violation-count moderate">31</td>
          <td class="violation-count moderate">27</td>
          <td class="violation-count moderate">35</td>
          <td class="violation-count moderate">32</td>
        </tr>
        <tr>
          <th scope="row">3 PM</th>
          <td class="violation-count high">58</td>
          <td class="violation-count high">64</td>
          <td class="violation-count high">61</td>
          <td class="violation-count high">67</td>
          <td class="violation-count high">55</td>
          <td class="violation-count moderate">42</td>
          <td class="violation-count moderate">38</td>
        </tr>
        <tr>
          <th scope="row">5 PM</th>
          <td class="violation-count high">71</td>
          <td class="violation-count high">78</td>
          <td class="violation-count high">74</td>
          <td class="violation-count high">81</td>
          <td class="violation-count high">68</td>
          <td class="violation-count moderate">45</td>
          <td class="violation-count moderate">41</td>
        </tr>
        <tr>
          <th scope="row">8 PM</th>
          <td class="violation-count moderate">22</td>
          <td class="violation-count moderate">26</td>
          <td class="violation-count moderate">24</td>
          <td class="violation-count moderate">28</td>
          <td class="violation-count moderate">31</td>
          <td class="violation-count moderate">35</td>
          <td class="violation-count moderate">29</td>
        </tr>
      </tbody>
    </table>
    <div class="schedule-legend">
      <div class="legend-item">
        <span class="legend-color minimal"></span>
        <span>Minimal (0-5)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color low"></span>
        <span>Low (6-20)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color moderate"></span>
        <span>Moderate (21-40)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color high"></span>
        <span>High (41-75)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color critical"></span>
        <span>Critical (76+)</span>
      </div>
      <div class="legend-item peak-hours">
        <span class="legend-icon">â˜…</span>
        <span>Peak Student Hours (7-10 AM)</span>
      </div>
    </div>
  </div>

  <!-- Table removed - interactive visualization only -->

  <!-- Controls removed - no data available for interaction -->
</div>

<style>
  .temporal-chart {
    --student-highlight: #fbbf24;
  }

  .schedule-table-container {
    width: 100%;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .violations-schedule {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .violations-schedule th,
  .violations-schedule td {
    padding: 0.75rem 0.5rem;
    text-align: center;
    border-bottom: 1px solid var(--color-border);
    color: #111827;
  }

  .violations-schedule th {
    background: #f8fafc;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid var(--color-border);
  }

  .violations-schedule th[scope="row"] {
    background: white;
    text-align: left;
    font-weight: 500;
    min-width: 60px;
  }

  .student-peak-hour {
    background: #fef3c7;
    border-left: 4px solid var(--student-highlight);
  }

  .student-peak-hour th[scope="row"] {
    background: #fef3c7;
    font-weight: 600;
  }

  .violation-count {
    font-weight: 600;
    border-radius: 4px;
    padding: 0.25rem;
  }

  .violation-count.minimal {
    background: #f0f9ff;
    color: #0c4a6e;
  }

  .violation-count.low {
    background: #ecfdf5;
    color: #065f46;
  }

  .violation-count.moderate {
    background: #fef3c7;
    color: #92400e;
  }

  .violation-count.high {
    background: #fed7aa;
    color: #9a3412;
  }

  .violation-count.critical {
    background: #fecaca;
    color: #991b1b;
  }

  .schedule-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-top: 1px solid var(--color-border);
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #374151;
  }

  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .legend-color.minimal {
    background: #f0f9ff;
  }

  .legend-color.low {
    background: #ecfdf5;
  }

  .legend-color.moderate {
    background: #fef3c7;
  }

  .legend-color.high {
    background: #fed7aa;
  }

  .legend-color.critical {
    background: #fecaca;
  }

  .legend-item.peak-hours {
    font-weight: 600;
    color: #92400e;
  }

  .legend-icon {
    font-size: 1rem;
  }

  /* Chart controls */
  .chart-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .filter-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .day-filter {
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.5rem;
  }

  .day-filter legend {
    font-weight: 600;
    padding: 0 0.5rem;
  }

  .day-filter label {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-right: 1rem;
  }

  /* Legend */
  .chart-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
  }

  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
  }

  .legend-color.student-highlight {
    background-color: var(--student-highlight);
    border: 2px solid #92400e;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .heatmap-container {
      height: 300px;
    }

    .chart-filters {
      flex-direction: column;
    }
  }
</style>

<!-- JavaScript removed - using static placeholder visualization -->