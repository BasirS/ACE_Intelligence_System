import"./hoisted.C6e_9ZjQ.js";import"./DataVisualizationLayout.astro_astro_type_script_index_0_lang.BZ9RW9NV.js";import"./hoisted.BD00WWJs.js";document.addEventListener("DOMContentLoaded",()=>{const d=document.querySelectorAll("section[id]"),e=new IntersectionObserver(o=>{o.forEach(r=>{if(r.isIntersecting){const a=r.target.id||"hero";typeof gtag<"u"&&gtag("event","section_view",{section_name:a,page_title:document.title})}})},{threshold:.3});d.forEach(o=>e.observe(o));let t=0;const n=()=>{const o=Math.round(window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100);o>t&&(t=o,[25,50,75,90].includes(t)&&typeof gtag<"u"&&gtag("event","scroll_depth",{scroll_depth:t,page_title:document.title}))};let i;window.addEventListener("scroll",()=>{clearTimeout(i),i=setTimeout(n,100)},{passive:!0});const s=document.getElementById("route-analyzer");if(s){const o=s.querySelector('button[type="submit"]');o&&o.addEventListener("click",()=>{typeof gtag<"u"&&gtag("event","route_analysis_started",{page_title:document.title,section:"homepage"})})}window.addEventListener("load",()=>{if("performance"in window){const o=performance.now(),r=performance.getEntriesByType("navigation")[0];typeof gtag<"u"&&gtag("event","page_performance",{load_time:Math.round(o),dom_content_loaded:r?.domContentLoadedEventEnd||0,page_title:document.title})}})});async function y(){try{const e=await(await fetch("/data/insights/hourly_agg.csv")).text();return p(e,t=>({weekday:t.weekday||"",hour:parseInt(t.hour)||0,violations:parseInt(t.violations)||0}))}catch(d){return console.error("Failed to load hourly data:",d),[]}}function p(d,e){const t=d.trim().split(`
`),n=t[0].split(",").map(i=>i.trim());return t.slice(1).map(i=>{const s=i.split(",").map(r=>r.trim()),o=n.reduce((r,a,l)=>(r[a]=s[l],r),{});return e(o)}).filter(Boolean)}class g{constructor(){this.form=document.getElementById("route-form"),this.resultsContainer=document.getElementById("analysis-results"),this.errorContainer=document.getElementById("error-container"),this.hourlyData=[],this.init()}async init(){await this.loadData(),this.attachEventListeners()}async loadData(){try{this.hourlyData=await y()}catch(e){console.error("Failed to load route analysis data:",e)}}attachEventListeners(){this.form.addEventListener("submit",e=>this.handleSubmit(e)),this.form.querySelectorAll("input, select").forEach(e=>{e.addEventListener("blur",()=>this.validateField(e))}),document.getElementById("retry-button")?.addEventListener("click",()=>{this.hideError(),this.form.scrollIntoView({behavior:"smooth"})}),document.getElementById("contact-officials")?.addEventListener("click",()=>{this.handleContactOfficials()}),document.getElementById("share-story")?.addEventListener("click",()=>{this.handleShareStory()}),document.getElementById("join-campaign")?.addEventListener("click",()=>{this.handleJoinCampaign()})}async handleSubmit(e){if(e.preventDefault(),!!this.validateForm()){this.showLoading();try{const t=new FormData(this.form),n=await this.performAnalysis(t);this.displayResults(n)}catch{this.showError("Unable to analyze your route. Please try again.")}finally{this.hideLoading()}}}validateForm(){let e=!0;return this.form.querySelectorAll("[required]").forEach(n=>{this.validateField(n)||(e=!1)}),e}validateField(e){const t=e.checkValidity();return e.classList.remove("error"),t||e.classList.add("error"),t}async performAnalysis(e){const t=e.get("busRoute"),n=e.get("destination"),i=e.get("departureTime"),s=parseInt(e.get("daysPerWeek")),o=e.get("isStudent")==="true",r=parseInt(i.split(":")[0]),a=this.hourlyData.filter(u=>u.hour>=r-1&&u.hour<=r+1&&["Monday","Tuesday","Wednesday","Thursday","Friday"].includes(u.weekday)),l=a.length>0?a.reduce((u,m)=>u+m.violations,0)/a.length:150,c=Math.round(l*s),h=Math.round(c*2.3);return{busRoute:t,destination:n,departureTime:i,daysPerWeek:s,isStudent:o,violationsPerWeek:c,minutesLostWeekly:h,studySessionsDisrupted:o?Math.round(c*.6):0,semesterHoursLost:o?Math.round(h*16/60):0,insights:this.generateInsights(t,c,h,o)}}generateInsights(e,t,n,i){const s=[];return t>100&&s.push({icon:"🚨",text:`Your ${e} route experiences high violation activity (${t} per week). This is significantly above the city average.`}),n>60&&s.push({icon:"⏰",text:`You lose ${n} minutes weekly to bus delays - that's ${Math.round(n*52/60)} hours per year.`}),i&&s.push({icon:"📚",text:'As a student, these delays directly impact your "rolling study hall" time and academic productivity.'}),s.push({icon:"💡",text:"ClearLane targeted enforcement could reduce these delays by up to 40% with focused intervention."}),s}displayResults(e){this.updateStat("violation-exposure",e.violationsPerWeek),this.updateStat("time-lost",e.minutesLostWeekly),e.isStudent&&(this.updateStat("study-impact",e.studySessionsDisrupted),this.updateStat("semester-impact",e.semesterHoursLost),document.getElementById("study-impact")?.removeAttribute("hidden"),document.getElementById("semester-impact")?.removeAttribute("hidden"));const t=document.getElementById("route-insights");t.innerHTML=e.insights.map(n=>`
        <div class="insight-item">
          <span class="insight-icon" aria-hidden="true">${n.icon}</span>
          <span class="insight-text">${n.text}</span>
        </div>
      `).join(""),this.resultsContainer.removeAttribute("hidden"),this.resultsContainer.scrollIntoView({behavior:"smooth"}),window.currentAnalysis=e}updateStat(e,t){const i=document.getElementById(e)?.querySelector(".stat-number");i&&this.animateNumber(i,0,t,1e3)}animateNumber(e,t,n,i){const s=performance.now(),o=r=>{const a=r-s,l=Math.min(a/i,1),c=Math.round(t+(n-t)*l);e.textContent=c.toLocaleString(),l<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}showLoading(){const e=document.getElementById("analyze-button");e.classList.add("loading"),e.disabled=!0}hideLoading(){const e=document.getElementById("analyze-button");e.classList.remove("loading"),e.disabled=!1}showError(e){this.hideResults(),document.getElementById("error-text").textContent=e,this.errorContainer.removeAttribute("hidden"),this.errorContainer.scrollIntoView({behavior:"smooth"})}hideError(){this.errorContainer.setAttribute("hidden","")}hideResults(){this.resultsContainer.setAttribute("hidden","")}handleContactOfficials(){const e=window.currentAnalysis;if(!e)return;const t=`ClearLane: Improve ${e.busRoute} Route Enforcement`,n=`Dear MTA Officials,

I am a regular rider of the ${e.busRoute} route to ${e.destination}.

Based on data analysis, this route experiences ${e.violationsPerWeek} violations per week during my commute time, causing me to lose ${e.minutesLostWeekly} minutes weekly.

${e.isStudent?'As a student, I depend on bus reliability for my academic success. These delays disrupt my "rolling study hall" time.':""}

I support the ClearLane Initiative's targeted enforcement approach to address these specific hotspots.

Please consider implementing focused enforcement during peak hours on routes serving students and workers.

Thank you for your attention to this matter.`;window.location.href=`mailto:?subject=${encodeURIComponent(t)}&body=${encodeURIComponent(n)}`}handleShareStory(){const e=window.currentAnalysis;if(!e)return;const t=`My ${e.busRoute} bus route has ${e.violationsPerWeek} violations per week, costing me ${e.minutesLostWeekly} minutes of study time. Support #ClearLane targeted enforcement! 🚌📚`,n=window.location.href;navigator.share?navigator.share({title:"ClearLane: My Commute Analysis",text:t,url:n}):(navigator.clipboard.writeText(`${t} ${n}`),this.showToast("Share text copied to clipboard!"))}handleJoinCampaign(){window.open("#join-campaign","_blank")}showToast(e){const t=document.createElement("div");t.className="toast",t.textContent=e,t.style.cssText=`
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 1rem;
        border-radius: 4px;
        z-index: 1000;
      `,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},3e3)}}document.addEventListener("DOMContentLoaded",()=>{new g});
